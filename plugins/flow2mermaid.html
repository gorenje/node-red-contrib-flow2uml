<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   window.FlowToMermaid={constructMermaid:function(e,l="TB",n=void 0){for(var r={payload:e},e=r.payload.filter(e=>"tab"!=e.type&&"group"!=e.type),t={},i=0;i<e.length;i++){var a=e[i];t[a.id]=a}var s=n,o=(n||(s={nodes:{node:e=>t[e],subflow:e=>t[e]}}),e=>e&&{nnull:"not null",eq:"==",neq:"!=",lt:"<",lte:"<=",gt:">",gte:">=",hask:"has key",cont:"contains"}[e]||e),p=e=>e.replaceAll("&","&amp;").replaceAll("#","#35;").replaceAll("[","#91;").replaceAll("]","#93;").replaceAll("(","#40;").replaceAll(")","#41;").replaceAll("|","#124;").replaceAll(">","&gt;").replaceAll("<","&lt;").replaceAll("{","#123;").replaceAll("}","#125;").replaceAll("/","#47;"),u=(e,l=void 0)=>{var n=e.name||e.type;switch(l=l?"|"+p(l)+"| ":"",n=p(n),e.type){case"switch":case"join":case"split":return l+e.id+'{"'+n+'"}';case"link call":case"link out":if(e.mode&&"return"==e.mode)return l+e.id+"[\\Link Return/]";if(!e.name||e.name.match(/^link out/)){if("dynamic"==e.linkType)return l+e.id+'{{"'+(n="\\Dynamic Target/")+'"}}';var r=e.links&&0<e.links.length&&(t[e.links[0]]||s.nodes.node(e.links[0])),n=p(r&&r.name||e.type)}return l+e.id+'{{"'+n+'"}}';case"link in":return n=p(e.name||e.links&&0<e.links.length&&t[e.links[0]]&&t[e.links[0]].name||e.type),l+e.id+'{{"'+n+'"}}';case"junction":return l+e.id+'(("'+n+'"))';case"debug":return l+e.id+'(["'+n+'"])';default:return e.type.startsWith("subflow:")&&(r=s.nodes.subflow(e.type.replace(/subflow:/,"")),n=p(r&&r.name||e.type)),l+e.id+'["'+n+'"]'}};r.mermaid=["%% change this to LR Node-RED like UML","graph "+l];for(var c,i=0;i<e.length;i++){var d=e[i];if(d.links&&0<d.links.length&&"link out"==d.type)for(var h=0;h<d.links.length;h++)t[d.links[h]]&&r.mermaid.push(u(d)+" -.-> "+d.links[h]);if(d.wires&&0<d.wires.length)if("switch"==d.type)for(var m=0;m<d.wires.length;m++)for(var f=0;f<d.wires[m].length;f++)r.mermaid.push(u(d)+" --\x3e "+u(t[d.wires[m][f]],(c=d.rules[m]).v&&c.t?o(c.t)+" "+c.v:c.v&&!c.t?c.v:o(c.t)));else{var k,w=d.outputLabels;d.type.startsWith("subflow:")&&(w=(k=s.nodes.subflow(d.type.replace(/subflow:/,"")))&&k.outputLabels||w);for(m=0;m<d.wires.length;m++)for(f=0;f<d.wires[m].length;f++)r.mermaid.push(u(d)+" --\x3e "+u(t[d.wires[m][f]],w&&w[m]||void 0))}}return r.mermaid.join("\n")}};
  
   function obtainCurrentActiveFlow() {
      var activeWorkspace = RED.workspaces.active();
      var nodes = RED.nodes.groups(activeWorkspace);

      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
      nodes = nodes.concat(RED.nodes.filterNodes({ z: activeWorkspace }));

      RED.nodes.eachConfig(function (n) {
        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
          // Grab any config nodes scoped to this flow that don't
          // require any flow-nodes to use them
          nodes.push(n);
        }
      });

      var parentNode = RED.nodes.workspace(
        activeWorkspace
      ) || RED.nodes.subflow(activeWorkspace);

      nodes.unshift(parentNode);

      return RED.nodes.createExportableNodeSet(nodes)
   };

   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'Flow2Mermaid') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("Flow2MermaidCfg"),
             type: "Flow2MermaidCfg",
             hasUsers: false, 
             users: [],
             name: "Flow2Mermaid",
             label: function() { return this.name || "Flow2Mermaid"},
             /* values and data defined by this config node */
             direction: "TB", // Default data
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Flow2Mermaid"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Flow2Mermaid",
         label: "Flow to UML", // short name for the tab
         name: "Flow to UML", // long name for the menu
         content: content,
         closeable: true,
         // disableOnEdit: true,
         enableOnEdit: true,
         iconClass: "fa fa-shower" // your fontawesome icon
      });

      ensureYourConfigNodeExists();

      var doSomething = (e) => {
         if (e) { e.preventDefault(); }

         var mermaidTxt = FlowToMermaid.constructMermaid(obtainCurrentActiveFlow(), globalYourConfigNode.direction, RED);
         
         RED.clipboard.copyText(mermaidTxt)
         // console.log( mermaidTxt )

         RED.notify("Mermaid UML has been copied to pasteboard.", "success");
      }

      $('#node-input-generate-diagram-but').on('click', (e) => {
         doSomething(e);
      })

      /* name of action will become "My Sidebar Action", label is generated
         from action name - see https://nodered.org/docs/api/ui/actions/ */
      RED.actions.remove("flow2mermaid:convert-flow-to-uml")
      RED.actions.add("flow2mermaid:convert-flow-to-uml",function() {
        doSomething();
      });

      // At startup load your config node data into the plugin sidebar html elements
      $('#node-input-direction').val(globalYourConfigNode.direction)

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-direction").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

         if (globalYourConfigNode.direction != data) {
            globalYourConfigNode.direction = data;
            // Since the config node has been updated, the 'Deploy' button should become active
            RED.nodes.dirty(true);
         }
      })
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Flow2Mermaid">

<div class="form-row" style="margin-left: 15px; margin-top: 30px;">
   <label for="node-input-direction"><i class="fa fa-tag"></i> Direction</label>
   <select id="node-input-direction">
        <option value="TB">Top to Bottom</option>
        <option value="LR">Left to Right</option>
      </select>
</div>

<div class="form-row" style="margin-left: 15px;">
   <button id="node-input-generate-diagram-but"
           class="red-ui-button">Generate Mermaid Diagram</button>
</div>
</script>