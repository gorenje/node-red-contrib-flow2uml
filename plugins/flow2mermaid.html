<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   (()=>{function F(e,a,r){switch(e.arrow||"arrow"){case"--":case"line":a=""!==r?` -- "${r}" --- `:" --- ";break;case"--\x3e":case"arrow":a=""!==r?` -- "${r}" --> `:" --\x3e ";break;case"==>":case"thickarrow":a=""!==r?` == "${r}" ==> `:" ==> ";break;case"-.->":case"dotarrow":a=""!==r?` -. "${r}" .-> `:" -.-> ";break;case"-.-":a=""!==r?` -. "${r}" -.- `:" -.- ";break;case"==":a=""!==r?` == "${r}" === `:" === ";break;case"<--\x3e":a=""!==r?` <-- "${r}" --> `:" <---\x3e ";break;case"<-.->":a=""!==r?` <-. "${r}" .-> `:" <-.-> ";break;case"<==>":a=""!==r?` <== "${r}" ==> `:" <===> ";break;case"--x":a=""!==r?` -- "${r}" --x `:" --x ";break;case"-.-x":a=""!==r?` -. "${r}" .-x `:" -.-x ";break;case"==x":a=""!==r?` == "${r}" ==x `:" ===x ";break;case"x--x":a=""!==r?` x-- "${r}" --x `:" x--x ";break;case"x-.-x":a=""!==r?` x-. "${r}" .-x `:" x-.-x ";break;case"x==x":a=""!==r?` x== "${r}" ==x `:" x===x ";break;case"--o":a=""!==r?` -- "${r}" --o `:" --o ";break;case"-.-o":a=""!==r?` -. "${r}" .-o `:" -.-o ";break;case"==o":a=""!==r?` == "${r}" ==o `:" ===o ";break;case"o--o":a=""!==r?` o-- "${r}" --o `:" o--o ";break;case"o-.-o":a=""!==r?` o-. "${r}" .-o `:" o-.-o ";break;case"o==o":a=""!==r?` o== "${r}" ==o `:" o===o "}return a}window.FlowToMermaid={constructMermaid:function(e,a="TB",r=void 0){for(var n={payload:e},t={},e=n.payload.filter(e=>("group"==e.type&&(t[e.id]={nodesids:[...e.nodes||[]],name:e.name||`**missing name ${e.id}**`,env:[...e.env||[]]}),"tab"!=e.type&&"group"!=e.type)),o={},l=0;l<e.length;l++){var s=e[l];o[s.id]=s}var i=r,c=(r||(i={nodes:{node:e=>o[e],subflow:e=>o[e]}}),e=>e&&{nnull:"not null",eq:"==",neq:"!=",lt:"<",lte:"<=",gt:">",gte:">=",hask:"has key",cont:"contains"}[e]||e),d=e=>e.replaceAll("&","&amp;").replaceAll("#","#35;").replaceAll("[","#91;").replaceAll("]","#93;").replaceAll("(","#40;").replaceAll(")","#41;").replaceAll("|","#124;").replaceAll(">","&gt;").replaceAll("<","&lt;").replaceAll("{","#123;").replaceAll("}","#125;").replaceAll("/","#47;").replaceAll('"',"#34;"),h=(e,a=void 0)=>{if(!e)return"";var r=e.name||e.type;switch(a=a?'|"'+d(a)+'"| ':"",r=d(r),e.type){case"switch":case"join":case"split":return a+e.id+'{"'+r+'"}';case"link call":case"link out":if(e.mode&&"return"==e.mode)return a+e.id+"[\\Link Return/]";if(!e.name||e.name.match(/^link out/)){if("dynamic"==e.linkType)return a+e.id+'{{"'+(r="\\Dynamic Target/")+'"}}';var n=e.links&&0<e.links.length&&(o[e.links[0]]||i.nodes.node(e.links[0])),r=d(n&&n.name||e.type)}return a+e.id+'{{"'+r+'"}}';case"link in":return r=d(e.name||e.links&&0<e.links.length&&o[e.links[0]]&&o[e.links[0]].name||e.type),a+e.id+'{{"'+r+'"}}';case"junction":return a+e.id+'(("conn"))';case"inject":case"debug":return a+e.id+'(["'+r+'"])';case"http in":return a+e.id+'["'+d("["+e.method+"] "+e.url)+'"]';case"mermaid-flowchart":return e.id+`@{ shape: "${e.shape}", label: "${r}" }`;default:return e.type.startsWith("subflow:")?(n=i.nodes.subflow(e.type.replace(/subflow:/,"")),r=d(n&&n.name||e.type),a+e.id+'[/"'+r+'"/]'):a+e.id+'["'+r+'"]'}};n.mermaid=["%% Generated by the Flow2UML Node @ https://flowhub.org/flow2uml","%% change direction to LR for Node-RED left-to-right UML","flowchart "+a],console.log("FLOW2UML: WARNING when copy & pasting flow chart nodes, their connections details are losts."),console.log("FLOW2UML: WARNING This is because the configuration of wires is based on node ids, these "),console.log("FLOW2UML: WARNING node ids change on copy and paste but aren't updated in the configuration "),console.log("FLOW2UML: WARNING of individual flowchart nodes.");for(var p,l=0;l<e.length;l++){var m=e[l];if(m.links&&0<m.links.length&&"link out"==m.type)for(var u=0;u<m.links.length;u++)o[m.links[u]]&&n.mermaid.push(h(m)+" -.-> "+m.links[u]);if(m.wires&&0<m.wires.length)if("mermaid-flowchart"==m.type){(m.wirecfgs||[]).forEach(e=>{var a,r;e.id==m.id&&(r=m.id,o[r])&&(r=" --\x3e ",a=d(e.name||""),r=F(e," --\x3e ",a),n.mermaid.push(h(m)+r+h(m)))});for(var f=0;f<m.wires.length;f++)for(var k=0;k<m.wires[f].length;k++){var w=m.wires[f][k];(m.wirecfgs||[]).forEach(e=>{var a,r;e.id==w&&o[w]&&(r=" --\x3e ",a=d(e.name||""),r=F(e," --\x3e ",a),n.mermaid.push(h(m)+r+h(o[m.wires[f][k]],b&&b[f]||void 0)))})}}else if("switch"==m.type)for(f=0;f<m.wires.length;f++)for(k=0;k<m.wires[f].length;k++)o[m.wires[f][k]]&&n.mermaid.push(h(m)+" --\x3e "+h(o[m.wires[f][k]],(p=m.rules[f]).v&&p.t?c(p.t)+" "+p.v:p.v&&!p.t?p.v:c(p.t)));else{var g,b=m.outputLabels;m.type.startsWith("subflow:")&&(g=i.nodes.subflow(m.type.replace(/subflow:/,"")),b=g&&g.outputLabels||b);for(f=0;f<m.wires.length;f++)for(k=0;k<m.wires[f].length;k++)o[m.wires[f][k]]&&n.mermaid.push(h(m)+" --\x3e "+h(o[m.wires[f][k]],b&&b[f]||void 0))}}for(var v=Object.keys(t),y=new Set,x=e=>{var a;0<e.nodesids.length&&(n.mermaid.push(`subgraph "${d(e.name)}"`),(a=(e.env.filter(e=>"MERMAID_DIRECTION"==e.name)[0]||{value:void 0}).value)&&n.mermaid.push("direction "+a),e.nodesids.forEach(e=>{"object"==typeof e?x(e):n.mermaid.push(e)}),n.mermaid.push("end"))},A=e=>"object"==typeof e||v.indexOf(e)<0,L=0;y.size<v.length&&L<2*v.length;)v.forEach(e=>{(!(t[e]&&0<t[e].nodesids.length)||(t[e].nodesids=t[e].nodesids.map(e=>{var a;return-1<v.indexOf(e)&&y.has(e)?(a={...t[e]},delete t[e],a):e}),t[e].nodesids.every(A)))&&y.add(e)}),L+=1;return Object.keys(t).forEach(e=>{0<t[e].nodesids.length&&x(t[e])}),n.mermaid.join("\n")},constructErlangStatem:function(e){let o=[];for(var l={},a=0;a<e.length;a++){var r=e[a];l[r.id]=r}for(a=0;a<e.length;a++){var s=e[a];if("mermaid-flowchart"==s.type){let t=(s.name||"unknown_state").replaceAll(/[\s\t\n ]/g,"_").toLowerCase();o.push(`
%%
%% Definition from '${s.name}' - #${s.id}
%%
`),(s.wirecfgs||[]).forEach(a=>{var r=a.name.split(";").map(e=>e.trim()),n=(l[a.id].name||"unknown_state").toLowerCase().replaceAll(/[\s\t\n ]/g,"_");if(1==r.length&&""==r[0])o.push(`
%
% Ignoring un-named link to '${n}' - #${a.id}
%
`);else{let e="";e=s.id==a.id?1==r.length?`handle_event(
    {call, From},
    <<"${r[0]}">>,
    ${t},
    Data
) ->
    {keep_state, Data, [{ reply, From, ${r[2]||"ok"} }]};`:`handle_event(
    {call, From},
    {<<"${r[0]}">>, <<"${r[1]}">>},
    ${t},
    Data
) ->
    {keep_state, Data, [{ reply, From, ${r[2]||"ok"} }]};`:1==r.length?`handle_event(
    {call, From},
    <<"${r[0]}">>,
    ${t},
    Data
) ->
    {next_state, ${n}, Data, [{ reply, From, ${r[2]||"ok"} }]};`:`handle_event(
    {call, From},
    {<<"${r[0]}">>, <<"${r[1]}">>},
    ${t},
    Data
) ->
    {next_state, ${n}, Data, [{ reply, From, ${r[2]||"ok"} }]};`,o.push(e)}})}}return o.join("\n")}}})();
  
   function obtainCurrentActiveFlow() {
      // check whether there is a current selection of nodes: if so, use that instead
      // of the current active tab.
      if ( Object.keys(RED.view.selection()).length > 0 && RED.view.selection().nodes.length > 0 ) {
         return RED.nodes.createExportableNodeSet(RED.view.selection().nodes)
      }

      var activeWorkspace = RED.workspaces.active();
      var nodes = RED.nodes.groups(activeWorkspace);

      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
      nodes = nodes.concat(RED.nodes.filterNodes({ z: activeWorkspace }));

      RED.nodes.eachConfig(function (n) {
        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
          // Grab any config nodes scoped to this flow that don't
          // require any flow-nodes to use them
          nodes.push(n);
        }
      });

      var parentNode = RED.nodes.workspace(
        activeWorkspace
      ) || RED.nodes.subflow(activeWorkspace);

      nodes.unshift(parentNode);

      return RED.nodes.createExportableNodeSet(nodes)
   };

   function getMermaidLink(mermaidTxt) {
      /* 
       * this snippet isn't taken from
       *   https://github.com/mermaid-js/mermaid-live-editor/blob/develop/src/lib/util/serde.ts
       * but it comes from there. Using base64 instead of pako because
       * base64 does not require installing any extras.
       */
      let payload = {
         "code":mermaidTxt,
         "mermaid":"{\n  \"theme\": \"default\"\n}",
         "autoSync":false,
         "updateDiagram":false,
         "panZoom":true,
         "pan": {
            "x":261.5279541015625,
            "y":80.74539184570312
         },
         "zoom": 0.829212067225414,
         "editorMode":"code"
      }
      return "https://mermaid.live/edit#base64:" + btoa( JSON.stringify(payload) )
   };
   
   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'Flow2MermaidCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("Flow2MermaidCfg"),
             type: "Flow2MermaidCfg",
             hasUsers: false, 
             users: [],
             name: "Flow2Uml",
             label: function() { return this.name || "Flow2Uml"},
             /* values and data defined by this config node */
             direction: "TB", // Default data
             genmereditor: ""
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Flow2Mermaid"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Flow2Mermaid",
         label: "Flow2Uml", // short name for the tab
         name: "Flow to UML", // long name for the menu
         content: content,
         closeable: false,
         enableOnEdit: true,
         iconClass: "fa fa-shower", // your fontawesome icon
         onchange: () => { } /* called when tab becomes visible */
      });

      ensureYourConfigNodeExists();
      /* Upgrading node causes errors here since the genmereditor attribute is defined on the "old" config
         node. Hence define it here incase this is the "old" config ndoe. The new config node has this
         attribute *but* has the same type so the new config isn't installed.
      */
      if ( !globalYourConfigNode.genmereditor ) { globalYourConfigNode.genmereditor = ""; RED.nodes.dirty(true); }

      $('#node-input-genmereditor-mermaid-code').html("<code>" + globalYourConfigNode.genmereditor.replaceAll("\n","<br>") + "</code>");
      $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(globalYourConfigNode.genmereditor))
      $('#genmermaid-view-uml-link').attr('href', getMermaidLink(globalYourConfigNode.genmereditor));

      $("#btn_genmercopy").on('click', (e) => {
         if ( e ) e.preventDefault();
         RED.clipboard.copyText(atob($('#node-input-genmereditor-mermaid-code').data('mermaid')))
         RED.notify("Mermaid UML has been copied to pasteboard.", "success");
      })

      $("#btn_genmersave").on('click', (e) => {
         var data = atob($('#node-input-genmereditor-mermaid-code').data('mermaid'));
         ensureYourConfigNodeExists();
         
         if (globalYourConfigNode.genmereditor != data) {
            globalYourConfigNode.genmereditor = data;
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(data));
            RED.nodes.dirty(true);
         }
      })

      var doSomething = (e) => {
         if (e) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         var mermaidTxt = FlowToMermaid.constructMermaid(obtainCurrentActiveFlow(), globalYourConfigNode.direction, RED);         

         try {
            /*
            * using encode and unescape here becuase the contents can cause an error:
            * ==> Uncaught DOMException: String contains an invalid character
            * from Stackoverflow, unescape & encode can fix that:
            * ==> https://stackoverflow.com/questions/23223718/failed-to-execute-btoa-on-window-the-string-to-be-encoded-contains-characte
            * But this can alter the text because the encoding isn't Utf8 but encode & unescape forces the encoding to become Utf8.
            */
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(mermaidTxt))
         } catch (ex) {
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(unescape(encodeURIComponent(mermaidTxt))))
         }

         try {
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(mermaidTxt));
         } catch (ex ) {
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(unescape(encodeURIComponent(mermaidTxt))))
         }

         try {
            $('#btn_genmersave').attr('href', "data:text/plain;base64," + btoa(mermaidTxt));
         } catch (ex ) {
         }

         try {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + mermaidTxt.replaceAll("\n","<br>") + "</code>");
         } catch ( ex ) {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + unescape(encodeURIComponent(mermaidTxt)).replaceAll("\n","<br>") + "</code>");
         }
      }

      RED.actions.remove("flow2mermaid:convert-flow-to-uml")
      RED.actions.add("flow2mermaid:convert-flow-to-uml",function() {
        doSomething();
        var data = atob($('#node-input-genmereditor-mermaid-code').data('mermaid'));

        RED.clipboard.copyText(data)
        $('#genmermaid-view-uml-link').attr('href', getMermaidLink(data));

        RED.notify("Mermaid UML has been copied to pasteboard.", "success");
      });

      $('#node-input-generate-diagram-but').on('click', (e) => {
         doSomething(e);
      })

      $('#genmermaid-generate-statem').on('click', (e) => {
         e.preventDefault();

         ensureYourConfigNodeExists();
         
         let statemDef = FlowToMermaid.constructErlangStatem(obtainCurrentActiveFlow());

         try {
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(statemDef))
         } catch (ex) {
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(unescape(encodeURIComponent(statemDef))))
         }

         try {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + statemDef.replaceAll("\n","<br>").replaceAll(" ","&nbsp;") + "</code>");
         } catch ( ex ) {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + unescape(encodeURIComponent(statemDef)).replaceAll("\n","<br>").replaceAll(" ","&nbsp;") + "</code>");
         }
      })

      $('#node-input-generate-and-view-diagram-but').on('click', (e) => {
         doSomething(e);
         setTimeout(() => { $('#genmermaid-view-uml-link')[0].click() }, 100)
      })

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-genmerdirection").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

         if (globalYourConfigNode.direction != data) {
            globalYourConfigNode.direction = data;
            // Since the config node has been updated, the 'Deploy' button should become active
            RED.nodes.dirty(true);
         }
      })

      $("#node-input-genmerdirection").typedInput({
            types: [
               {
                  value: "genmerdirection",
                  
                  options: [
                        { "value":"TB", "label": "Top to Bottom"},
                        { "value":"LR", "label": "Left to Right"},
                        { "value":"BT", "label": "Bottom to Top"},
                        { "value":"RL", "label": "Right to Left"}
                 ]
               }
            ]
      });
      // At startup load your config node data into the plugin sidebar html elements
      $('#node-input-genmerdirection').val(globalYourConfigNode.direction)

      // Allow dynamic re-size after init. appearance 
      setTimeout(function () {
            $('#node-props').css('width', '100%');
      }, 30);
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
   .red-ui-tray-content #dialog-form {
    white-space: nowrap;
}

.full-row .red-ui-typedInput-container {
    min-width: 70%;
}

.col input {
    min-width: 100%;
}

.sml-lbl {
    height: 66px;
}

.sml-lbl label {
    font-size: smaller;
    margin-bottom: 0px;
    display: block !important;
}

.reg-lbl label {
    white-space: nowrap;
    margin-top: 5px;
    height: 0px;
}

.red-ui-editor .form-row label.full-lbl {
    white-space: normal;
    width: 100%;
}

.col {
    float: left;
    margin-right: 5px;
    min-height: 36px;
}

.col .red-ui-typedInput-container {
    width: 100% !important;
}

.col-50 {
    width: 50%;
}

.col-33 {
    width: 33%;
}

.col-66 {
    width: 66%;
}

.col-25 {
    width: 25%;
}

.col-75 {
    width: 75%;
}

.col-100 .red-ui-typedInput-container {
    width: 70% !important;
}

.col-100.no-label .red-ui-typedInput-container {
    width: 100% !important;
}

.txtarea {
    padding-bottom: 26px;
}

.txtarea label {
    vertical-align: top;
    margin-top: 3px;
}

.txtarea textarea {
    width: 70%;
    margin-bottom: -28px !important;
}

.btn-regular {
    margin-bottom: 14px !important;
}

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Flow2Mermaid">
   <div id="node-props" style="width: 460px; height: 100%; margin-left: 10px; margin-right: 15px; margin-top: 30px;">
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
         <button id="node-input-generate-diagram-but" type="button" class="red-ui-button btn-regular"><i class="fa fa-plug"></i> Generate Mermaid Diagram</button>
         <button id="node-input-generate-and-view-diagram-but" 
                   type="button" class="red-ui-button btn-regular"><i class="fa fa-eye"></i> Generate & View Diagram</button>      
      </div>

      <!--form-row-->
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
         <div class="col-100">
            <label for="node-input-genmerdirection"><i class="fa fa-compass"></i> Direction</label>
            <input type="text" id="node-input-genmerdirection">
         </div>
      </div>

      <!--form-row-->
      <div class="form-row"
         style="min-height: 250px; overflow: scroll; margin-left: 10px; margin-right: 15px; height: calc(100% - 300px); overflow: hidden;">
         <label for="node-input-genmereditor-mermaid-code"><i class="fa fa-pencil"></i> Mermaid</label>
         <div id="node-input-genmereditor-mermaid-code" style="border: 1px rgb(196, 196, 196) solid; border-radius: 5px; overflow: scroll; height: calc(100% - 80px);"></div>
      </div>

      <!--form-row-->
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
            <a href="#" download="flow.mermaid" id="btn_genmersave" type="button"
               class="red-ui-button btn-regular"><i class="fa fa-save"></i> Save</a>
               
            <a id="btn_genmercopy" style="margin-left: 5px;" type="button" class="red-ui-button btn-regular"><i class="fa fa-copy"></i> Copy to Clipboard</a>

            <a type="button"
               class="red-ui-button btn-regular" id="genmermaid-view-uml-link" style="margin-left: 5px;" target="_blank" href="#"><i class="fa fa-external-link"></i> View</a>

            <a type="button" class="red-ui-button btn-regular" id="genmermaid-generate-statem" style="margin-left: 10px;">Erlang Statem Def</a>
      </div>
   </div>
   <!--node-props-->

</script>