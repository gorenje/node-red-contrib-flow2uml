<script type="text/javascript">
  (function(){
  

  function frontendSupportFunction() {
  }

  var functTwo = (arg) => {

  };
  
  RED.nodes.registerType('mermaid-state-state',{
    color: '#D7D7A0',
    icon: "font-awesome/fa-map-marker",
    category: 'mermaid',
    paletteLabel: 'State',
    defaults: {
      name: {
        value:"state",
      },
      wirecfgs: {
        value: [] // { action: "", id: "", payload: "" } <<---- expected
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    // called when node is added to workspace also if copied and pasted.
    // once for each node added to the workspace
    onadd: function() {
    },

    // called when node added to palette - one time
    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function () {
      let that = this;

      var allOurWires = [];

      let addConfigField = (nde, currVal) => {
        var container = $("<div>", { class: "wirecfg form-row", "data-id": nde.id });

        container.append('<a href="#" style="float: right; color: red;" onclick="$(this).parent().remove(); return false;"><i class="fa fa-close"></i></a>')

        container.append('<a href="#" style="float: right; margin-right: 10px; color: green;" onclick="$(\'#node-input-wirecfgs-state-container\').append($(this).parent().clone()); return false;"><i class="fa fa-plus"></i></a>')

        var label = $('<label>', { "data-id": nde.id, onmouseover: "RED.view.reveal($(this).data('id'),true);RED.view.redraw();", onmouseout: "RED.view.redraw();" })

        if (nde.id == this.id) {
          label.append('<i class="fa fa-rotate-right"></i>&nbsp;')
          label.append($("<span>").text(RED.utils.getNodeLabel(nde) + " (this state)"))
        } else {
          label.append('<i class="fa fa-map-marker"></i>&nbsp;')
          label.append($("<span>").text(RED.utils.getNodeLabel(nde)))
        }

        container.append(label)
        container.append($('<br/>'))
        container.append($('<input>', { style: 'width: 40%;', class: 'wirecfg-action', type: "text", placeholder: "Action", value: currVal.action }))
        container.append($('<input>', { style: 'width: 50%; margin-left: 2%; margin-right: 2%;', class: 'wirecfg-payload', type: "text", placeholder: "Payload", value: currVal.payload }))

        container.appendTo($('#node-input-wirecfgs-state-container'))
      }

      RED.nodes.getDownstreamNodes(RED.nodes.node(this.id)).forEach(nde => {
        if (!this.wirecfgs.some((d) => d.id == nde.id)) {
          this.wirecfgs.push({ id: nde.id, action: "", payload: "" })
        }
        allOurWires.push(nde.id)
      })

      this.wirecfgs.sort((a, b) => a.id < b.id).forEach(currVal => {
        let nde = RED.nodes.node(currVal.id == "self" ? that.id : currVal.id)

        /* if ( !nde ) { return } */
        /* if ( allOurWires.indexOf(currVal.id) < 0 ) { return } */

        addConfigField(nde || that, currVal)
      })

      $('#node-input-add-self-button').on('click', (e) => {
        e.preventDefault();
        addConfigField(that, { id: that.id, action: "", payload: "" })
      })      
    },

    oneditcancel: function () {
    },

    oneditsave: function () {
      let that = this;
      let result = []
      $($('#node-input-wirecfgs-state-container').find('.wirecfg')).each((idx, elem) => {
        result.push({
          action: $(elem).find('.wirecfg-action').val(),
          id: $(elem).data("id") == that.id ? "self" : $(elem).data("id"),
          payload: $(elem).find('.wirecfg-payload').val()
        })
      })
      this.wirecfgs = result
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="mermaid-state-state">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-map-marker"></i> <span data-i18n="mermaid-state-state.label.state"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]mermaid-state-state.label.state">
  </div>

  <div class="form-row">
    <button class='red-ui-button' id='node-input-add-self-button'><i class="fa fa-rotate-right"></i> <span data-i18n="mermaid-state-state.label.add_keep_state"></span></button>
  </div>

  <div class="form-row">
    <div id="node-input-wirecfgs-state-container"></div>
  </div>
</script>
